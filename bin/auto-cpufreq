#!/usr/bin/env python3
#
# auto-cpufreq - Automatic CPU speed & power optimizer for Linux
#
# Blog post: http://foolcontrol.org/?p=3124

# core import
import sys
from subprocess import call, run

sys.path.append('../')
from source.core import *


# cli
@click.command()
@click.option("--monitor", is_flag=True, help="Monitor and suggest CPU optimizations")
@click.option("--live", is_flag=True, help="Monitor and make suggested CPU optimizations")
@click.option("--install/--remove", default=True, help="Install/remove daemon for automatic CPU optimizations")
@click.option("--log", is_flag=True, help="View live CPU optimization log made by daemon")
@click.option("--daemon", is_flag=True, hidden=True)
@click.option("--debug", is_flag=True, help="Show debug info (include when submitting bugs)")
def main(monitor, live, daemon, install, log, debug):
    if len(sys.argv) == 1:
        print("\n" + "-" * 32 + " auto-cpufreq " + "-" * 33 + "\n")
        print("Automatic CPU speed & power optimizer for Linux")
        print("\nExample usage:\nauto-cpufreq --monitor")
        print("\n-----\n")

        run(["auto-cpufreq", "--help"])
        footer()
    else:
        # Important: order does matter
        if daemon:
            if os.getenv("PKG_MARKER") == "SNAP" and dcheck == "enabled":
                while True:
                    root_check()
                    gov_check()
                    cpufreqctl()
                    sysinfo()
                    set_autofreq()
                    countdown(5)
                    run("clear")
            elif os.getenv("PKG_MARKER") != "SNAP":
                while True:
                    root_check()
                    gov_check()
                    cpufreqctl()
                    sysinfo()
                    set_autofreq()
                    countdown(5)
                    run("clear")
            else:
                print("\n" + "-" * 32 + " Daemon check " + "-" * 33 + "\n")
                print("ERROR:\n\nDaemon not enabled, must run install first, i.e: \nsudo auto-cpufreq --install")
                footer()
                exit(1)
        elif monitor:
            while True:
                root_check()
                running_daemon()
                gov_check()
                cpufreqctl()
                sysinfo()
                mon_autofreq()
                countdown(5)
                run("clear")
        elif live:
            while True:
                root_check()
                running_daemon()
                gov_check()
                cpufreqctl()
                sysinfo()
                set_autofreq()
                countdown(5)
                run("clear")
        elif log:
            # ToDo: fail if log is missing or empty (on)
            read_log()
        elif debug:
            footer()
            distro_info()
            driver_check()
            if os.getenv('PKG_MARKER') == "SNAP":
                print("Snap package: yes")
            else:
                print("Snap package: no")
            python_info()
            footer()
        elif install:
            if os.getenv('PKG_MARKER') == "SNAP":
                root_check()
                running_daemon()
                gov_check()
                run("snapctl set daemon=enabled", shell=True)
                run("snapctl start --enable auto-cpufreq", shell=True)
                deploy_complete_msg()
            else:
                root_check()
                running_daemon()
                gov_check()
                deploy_daemon()
                deploy_complete_msg()
        elif remove:
            if os.getenv('PKG_MARKER') == "SNAP":
                root_check()
                run("snapctl set daemon=disabled", shell=True)
                run("snapctl stop --disable auto-cpufreq", shell=True)
                if auto_cpufreq_log_file.exists():
                    auto_cpufreq_log_file.unlink()
                remove_complete_msg()
            else:
                root_check()
                remove()
                remove_complete_msg()


if __name__ == '__main__':
    main()
